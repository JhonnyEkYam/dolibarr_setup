# Configuracion de doli plana
# No esta envuelto por traefik
# se sirve puro y duro
services:
    mariadb:
        image: mariadb:12.1-noble
        environment:
            # Sintaxis ${VAR:-default}: Si la variable no existe en .env, usa el valor tras el guion.
            MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
            MYSQL_DATABASE: ${MYSQL_DATABASE:-dolidb}
            MYSQL_USER: ${MYSQL_USER:-dolidbuser}
            MYSQL_PASSWORD: ${MYSQL_PASSWORD:-dolidbpass}

        volumes:
            - ${BIND_VOLUME_MARIADB}:/var/lib/mysql

    web:
        image: dolibarr/dolibarr:22.0.3
        environment:
            TZ: "America/Mexico_City"
            DOLI_PROD: ${DOLI_PROD:-0}
            DOLI_DB_HOST: ${DOLI_DB_HOST:-mariadb}
            DOLI_DB_NAME: ${MYSQL_DATABASE:-dolidb}
            DOLI_DB_USER: ${MYSQL_USER:-dolidbuser}
            DOLI_DB_PASSWORD: ${MYSQL_PASSWORD:-dolidbpass}

            # --- Configuración de Instalación ---
            # Si es 1, llena la BD con facturas, clientes y pedidos falsos al instalar.
            # CRÍTICO: Debe ser 0 para producción o perderás tiempo limpiando datos basura.
            DOLI_INIT_DEMO: ${DOLI_INIT_DEMO:-0}

            # --- Configuración de Red ---
            # Define la URL base para generar enlaces internos y assets (CSS/JS).
            # Si esto no coincide con lo que escribes en el navegador, tendrás errores de CORS o redirecciones infinitas.
            DOLI_URL_ROOT: "${DOLI_URL_ROOT:-http://127.0.0.1:3102}"

            # --- Credenciales SuperAdmin ---
            # Solo se usan en la primera ejecución (instalación). Si la BD ya existe, se ignoran.
            DOLI_ADMIN_LOGIN: "${DOLI_ADMIN_LOGIN:-admin}"
            DOLI_ADMIN_PASSWORD: "${DOLI_ADMIN_PASSWORD:-admin}"

            # --- Tareas Programadas (Cron) ---
            # 1 = Activa automáticamente el módulo "Scheduled Jobs" en Dolibarr.
            # Necesario para facturas recurrentes, alertas de email, backups automáticos, etc.
            DOLI_CRON: ${DOLI_CRON:-0}

            # Token de seguridad (salt). Es la "contraseña" que protege la URL pública del cron.
            # Evita que un extraño ejecute tus tareas de mantenimiento visitando la URL pública.
            DOLI_CRON_KEY: ${DOLI_CRON_KEY:-mycronsecurekey}

            # Nombre que aparecerá en el título de la web y en los PDFs por defecto.
            DOLI_COMPANY_NAME: ${DOLI_COMPANY_NAME:-MyBigCompany}
            # --- Permisos (Windows vs Linux) ---
            #   --- No se usa cuando el HOST es windows ---
            # En Linux, esto iguala el dueño de los archivos al usuario de tu PC para evitar 'Permission Denied'.
            # En Windows, Docker Desktop maneja esto diferente, y forzarlo suele romper el arranque.
            # WWW_USER_ID: ${WWW_USER_ID:-1000} 
            # WWW_GROUP_ID: ${WWW_GROUP_ID:-1000}

        ports:
            # Mapeo Puerto Host : Puerto Contenedor
            - "${EXPOSED_PORT:-3100}:80"
        links:
            - mariadb
        volumes:
            # Documentos (PDFs generados, adjuntos, logos)
            - ${BIND_VOLUME_DOCUMENTS}:/var/www/documents
            # Módulos externos o plugins (custom development)
            - ${BIND_VOLUME_CUSTOM}:/var/www/html/custom

