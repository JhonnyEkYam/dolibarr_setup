services:
    traefik:
        image: traefik:${TRAEFIK_DOCKER_TAG:-v3.5.3}
        command:
            # --- Logs para Debug ---
            # Nivel DEBUG para ver detalles de conexiones y errores de configuración en tiempo real.
            - "--log.level=DEBUG"
            - "--accessLog=true"

            # --- Configuración Insegura (Local) ---
            # Habilita el dashboard en modo inseguro (puerto 8080) sin requerir autenticación.
            - "--api.insecure=true"

            - "--providers.docker=true"
            - "--providers.docker.exposedByDefault=false"

            # --- Puntos de Entrada ---
            # Solo HTTP estándar. No se configuran redirecciones a HTTPS para simplificar el desarrollo local.
            - "--entryPoints.http.address=:80"
            # Nota: Se omiten los resolvers de certificados (Let's Encrypt) ya que no funcionan en localhost.

        ports:
            - "80:80" # Acceso a la aplicación
            - "8080:8080" # Acceso al Dashboard de Traefik (http://localhost:8080)

        volumes:
            - "${DOCKER_SOCKET_PATH:-/var/run/docker.sock}:/var/run/docker.sock:ro"

        networks:
            - doli-net

    mariadb:
        image: mariadb:12.1-noble
        # Se mantiene el archivo de configuración lowmem para asegurar que el entorno de desarrollo
        # simule las restricciones de producción, evitando que funciones en local y falles en el deploy.
        command: --defaults-file=/etc/mysql/conf.d/my_lowmem.cnf

        environment:
            MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
            MYSQL_DATABASE: ${MYSQL_DATABASE:-dolidb}
            MYSQL_USER: ${MYSQL_USER:-dolidbuser}
            MYSQL_PASSWORD: ${MYSQL_PASSWORD:-dolidbpass}

        volumes:
            - ./dolibarr_mariadb:/var/lib/mysql
            - ./my_lowmem.cnf:/etc/mysql/conf.d/my_lowmem.cnf

        deploy:
            resources:
                limits:
                    memory: 180M

        networks:
            - doli-net

    web:
        image: dolibarr/dolibarr:21
        environment:
            DOLI_DB_HOST: mariadb
            DOLI_DB_NAME: ${MYSQL_DATABASE:-dolidb}
            DOLI_DB_USER: ${MYSQL_USER:-dolidbuser}
            DOLI_DB_PASSWORD: ${MYSQL_PASSWORD:-dolidbpass}
            # URL raíz ajustada para entorno local.
            DOLI_URL_ROOT: "http://localhost"
            # Modo desarrollo: Muestra errores de PHP en pantalla si ocurren (0).
            DOLI_PROD: 0
            PHP_INI_MEMORY_LIMIT: 128M
            TZ: "America/Mexico_City"

        volumes:
            - ./dolibarr_documents:/var/www/documents
            - ./dolibarr_custom:/var/www/html/custom

        deploy:
            resources:
                limits:
                    memory: 256M

        labels:
            - "traefik.enable=true"

            # --- Router Local ---
            # Regla simplificada para capturar tráfico de localhost.
            - "traefik.http.routers.dolibarr.rule=Host(`localhost`)"
            - "traefik.http.routers.dolibarr.entrypoints=http"
            # Nota: Se omite la compresión en desarrollo para facilitar la inspección del código fuente en el navegador.

        depends_on:
            - mariadb
        networks:
            - doli-net

networks:
    doli-net:
